
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scarcity: The Arena | Play Free Web Games</title>
    
    <meta name="description" content="Play Scarcity: The Arena. A fast-paced, free-to-play browser battle royale game. Survive the swarm, hunt for food, and climb the leaderboard.">
    <meta name="google-adsense-account" content="ca-pub-5185080427531248">

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5185080427531248" crossorigin="anonymous"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&display=swap');
        body { margin: 0; background-color: #09090b; color: #fafafa; font-family: 'Rajdhani', sans-serif; overflow-x: hidden; }
        
        /* Responsive Game Container */
        #game-wrapper { 
            position: relative; 
            width: 100%; 
            height: 65vh; /* Gives mobile users massive vertical screen real estate */
            background-color: #0f0f13; 
            overflow: hidden; 
            border: 1px solid #27272a; 
            border-radius: 0.5rem; 
            touch-action: none; 
            user-select: none; 
        }
        
        /* Snap back to widescreen on laptops/desktops */
        @media (min-width: 768px) {
            #game-wrapper { height: auto; aspect-ratio: 16/9; max-height: 75vh; }
        }

        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; outline: none; }
        .game-ui { position: absolute; inset: 0; z-index: 10; pointer-events: none; }
        .pointer-events-auto { pointer-events: auto; }
        .glow-text { text-shadow: 0 0 10px rgba(255, 62, 62, 0.8); }
        .touch-btn { background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; backdrop-filter: blur(4px); transition: background 0.1s; }
        .touch-btn:active { background: rgba(255,255,255,0.3); }
        
        /* Hide scrollbar for mobile nav */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ==========================================
        // 1. MAIN PORTAL ARCHITECTURE
        // ==========================================
        function App() {
            const [currentView, setCurrentView] = useState('HOME');

            return (
                <div className="min-h-screen flex flex-col">
                    {/* Header Navigation */}
                    <header className="bg-zinc-900 border-b border-zinc-800 p-4 sticky top-0 z-50 shadow-md">
                        <div className="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                            <h1 onClick={() => setCurrentView('HOME')} className="text-3xl font-black text-white tracking-widest cursor-pointer glow-text">SCARCITY</h1>
                            
                            {/* Horizontally scrollable on mobile to save space */}
                            <nav className="flex gap-4 md:gap-6 text-xs md:text-sm font-bold text-zinc-400 overflow-x-auto no-scrollbar whitespace-nowrap w-full md:w-auto justify-center md:justify-end pb-1 md:pb-0">
                                <button onClick={() => setCurrentView('HOME')} className={`hover:text-white transition-colors tracking-wider px-2 ${currentView === 'HOME' ? 'text-white border-b-2 border-rose-500' : ''}`}>PLAY</button>
                                <button onClick={() => setCurrentView('HOW_TO_PLAY')} className={`hover:text-white transition-colors tracking-wider px-2 ${currentView === 'HOW_TO_PLAY' ? 'text-white border-b-2 border-rose-500' : ''}`}>HOW TO PLAY</button>
                                <button onClick={() => setCurrentView('ABOUT')} className={`hover:text-white transition-colors tracking-wider px-2 ${currentView === 'ABOUT' ? 'text-white border-b-2 border-rose-500' : ''}`}>ABOUT</button>
                                <button onClick={() => setCurrentView('CONTACT')} className={`hover:text-white transition-colors tracking-wider px-2 ${currentView === 'CONTACT' ? 'text-white border-b-2 border-rose-500' : ''}`}>CONTACT</button>
                            </nav>
                        </div>
                    </header>

                    {/* Main Content Area */}
                    <main className="flex-1 max-w-6xl mx-auto w-full p-2 md:p-4 flex flex-col lg:flex-row gap-6 mt-2">
                        
                        {/* LEFT COLUMN: GAME OR PAGES */}
                        <div className="flex-1 flex flex-col gap-4">
                            {currentView === 'HOME' && (
                                <>
                                    {/* The Game Engine */}
                                    <GameEngine />
                                    
                                    {/* AdSense Slot - Placed directly below game where eyes naturally fall */}
                                    <div className="w-full h-[90px] bg-zinc-900 border border-zinc-800 flex items-center justify-center text-zinc-600 font-bold rounded-lg overflow-hidden relative shadow-inner">
                                        <span className="absolute z-0 text-xs uppercase tracking-widest">Advertisement</span>
                                        {/* Google AdSense ins tag */}
                                        <ins className="adsbygoogle z-10" style={{display:"block", width:"100%", height:"90px"}} data-ad-client="ca-pub-5185080427531248" data-ad-slot="YOUR_AD_SLOT_ID"></ins>
                                    </div>

                                    {/* Minimum SEO Anchor Text for AdSense Bots */}
                                    <div className="px-2 pb-4">
                                        <h2 className="text-xl font-bold text-white mb-1">Scarcity: The Arena</h2>
                                        <p className="text-zinc-500 text-sm leading-relaxed">
                                            A free-to-play, fast-paced browser battle royale. Manage your stamina, hunt for food, and survive the shrinking red zone to be the last player standing.
                                        </p>
                                    </div>
                                </>
                            )}

                            {currentView === 'HOW_TO_PLAY' && (
                                <article className="bg-zinc-900 p-6 md:p-8 rounded-xl border border-zinc-800 animate-fade-in">
                                    <h2 className="text-4xl font-black mb-4 text-white">Survival Guide</h2>
                                    <p className="text-zinc-400 mb-8 leading-relaxed text-lg">
                                        Welcome to <strong>Scarcity: The Arena</strong>. Resources are depleted. The map is shrinking. You must scavenge for food to cure hunger, manage your stamina during combat, and eliminate rival players. Only one survives.
                                    </p>
                                    
                                    <div className="grid md:grid-cols-2 gap-8 mb-10">
                                        <div className="bg-zinc-950 p-6 rounded-xl border border-zinc-800">
                                            <h3 className="text-2xl font-bold text-rose-500 mb-4 flex items-center gap-2">üì± Mobile Controls</h3>
                                            <ul className="text-zinc-400 space-y-4">
                                                <li className="flex items-start gap-3">
                                                    <div className="w-8 h-8 rounded-full bg-zinc-800 flex items-center justify-center shrink-0">üïπÔ∏è</div>
                                                    <div><strong className="text-white block">Virtual Joystick (Left Side)</strong> Drag to move your character and aim simultaneously.</div>
                                                </li>
                                                <li className="flex items-start gap-3">
                                                    <div className="w-8 h-8 rounded-full bg-zinc-800 flex items-center justify-center shrink-0 text-rose-500">‚öîÔ∏è</div>
                                                    <div><strong className="text-white block">Attack Button</strong> Tap to swing your weapon. Costs 15 Stamina.</div>
                                                </li>
                                                <li className="flex items-start gap-3">
                                                    <div className="w-8 h-8 rounded-full bg-zinc-800 flex items-center justify-center shrink-0">üí®</div>
                                                    <div><strong className="text-white block">Dash Button</strong> Tap to evade attacks. Costs 30 Stamina.</div>
                                                </li>
                                            </ul>
                                        </div>

                                        <div className="bg-zinc-950 p-6 rounded-xl border border-zinc-800">
                                            <h3 className="text-2xl font-bold text-emerald-500 mb-4 flex items-center gap-2">üíª Desktop Controls</h3>
                                            <ul className="text-zinc-400 space-y-4">
                                                <li className="flex items-start gap-3">
                                                    <div className="w-8 h-8 rounded bg-zinc-800 flex items-center justify-center shrink-0 font-bold font-mono">W</div>
                                                    <div><strong className="text-white block">W, A, S, D</strong> Use keyboard to move your character.</div>
                                                </li>
                                                <li className="flex items-start gap-3">
                                                    <div className="w-8 h-8 rounded bg-zinc-800 flex items-center justify-center shrink-0">üñ±Ô∏è</div>
                                                    <div><strong className="text-white block">Mouse Aim & Left Click</strong> Aim with cursor. Click to attack.</div>
                                                </li>
                                                <li className="flex items-start gap-3">
                                                    <div className="w-8 h-8 rounded bg-zinc-800 flex text-xs items-center justify-center shrink-0 font-bold font-mono">SHFT</div>
                                                    <div><strong className="text-white block">Shift Key</strong> Quick dash maneuver. Costs 30 Stamina.</div>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>

                                    <h3 className="text-2xl font-bold text-white mb-4 border-b border-zinc-700 pb-2">Patch Notes (v1.0.2)</h3>
                                    <ul className="text-zinc-400 space-y-2 list-disc pl-5">
                                        <li><strong className="text-emerald-400">UI Overhaul:</strong> Moved instructions to menu for a cleaner mobile gaming experience.</li>
                                        <li><strong className="text-rose-400">Balance:</strong> Added stamina penalty for missing attacks to prevent button-mashing.</li>
                                        <li><strong className="text-amber-400">Optimization:</strong> Improved canvas rendering engine to hit 60FPS on mid-tier mobile devices.</li>
                                    </ul>
                                </article>
                            )}

                            {currentView === 'ABOUT' && (
                                <div className="bg-zinc-900 p-8 rounded-xl border border-zinc-800">
                                    <h2 className="text-4xl font-black mb-6 glow-text">About Us</h2>
                                    <p className="text-zinc-400 mb-4 leading-relaxed">
                                        Founded in 2026, Scarcity Games is an independent game development studio dedicated to bringing high-adrenaline, serverless multiplayer experiences directly to your web browser. 
                                    </p>
                                    <p className="text-zinc-400 leading-relaxed">
                                        Our mission is to create games that require zero downloads, feature instant matchmaking, and run flawlessly on both high-end gaming rigs and standard mobile phones. Scarcity: The Arena is our flagship title, pushing the boundaries of what is possible with HTML5 Canvas and React.
                                    </p>
                                </div>
                            )}

                            {currentView === 'CONTACT' && (
                                <div className="bg-zinc-900 p-8 rounded-xl border border-zinc-800">
                                    <h2 className="text-4xl font-black mb-6 glow-text">Contact Us</h2>
                                    <p className="text-zinc-400 mb-6">Have feedback, found a bug, or want to inquire about business partnerships? We would love to hear from you.</p>
                                    <form className="space-y-4" onSubmit={e => { e.preventDefault(); alert("Message Sent!"); }}>
                                        <input type="text" placeholder="Your Name" required className="w-full bg-zinc-950 border border-zinc-800 p-4 rounded-xl text-white outline-none focus:border-rose-500" />
                                        <input type="email" placeholder="Your Email" required className="w-full bg-zinc-950 border border-zinc-800 p-4 rounded-xl text-white outline-none focus:border-rose-500" />
                                        <textarea placeholder="Your Message" required rows="5" className="w-full bg-zinc-950 border border-zinc-800 p-4 rounded-xl text-white outline-none focus:border-rose-500 resize-none"></textarea>
                                        <button type="submit" className="bg-white text-black font-black uppercase tracking-widest px-8 py-4 rounded-xl hover:bg-zinc-200 transition-colors w-full md:w-auto">Send Message</button>
                                    </form>
                                </div>
                            )}
                        </div>

                        {/* RIGHT COLUMN: SIDEBAR ADS & STATS */}
                        <aside className="w-full lg:w-72 flex flex-col gap-6">
                            {/* Leaderboard */}
                            <div className="bg-zinc-900 border border-zinc-800 p-6 rounded-xl shadow-lg">
                                <h3 className="font-bold text-white mb-4 border-b border-zinc-700 pb-2 uppercase tracking-widest text-sm">Top Survival Times</h3>
                                <ul className="space-y-3 text-sm font-mono">
                                    <li className="flex justify-between text-zinc-300"><span>1. Ghost_Hunter</span> <span className="text-emerald-400">420s</span></li>
                                    <li className="flex justify-between text-zinc-300"><span>2. Felix_N</span> <span className="text-emerald-400">385s</span></li>
                                    <li className="flex justify-between text-zinc-300"><span>3. WebSlayer99</span> <span className="text-emerald-400">312s</span></li>
                                    <li className="flex justify-between text-zinc-300"><span>4. ArenaKing</span> <span className="text-emerald-400">290s</span></li>
                                </ul>
                            </div>
                            
                            {/* Sticky Sidebar Ad - Hidden on very small screens to save space */}
                            <div className="hidden md:flex sticky top-24 w-full h-[600px] bg-zinc-900 border border-zinc-800 flex-col items-center justify-center text-zinc-600 font-bold rounded-lg overflow-hidden shadow-inner">
                                <span className="absolute z-0 text-xs uppercase tracking-widest">Advertisement</span>
                                {/* Google AdSense ins tag */}
                                <ins className="adsbygoogle z-10" style={{display:"block", width:"100%", height:"100%"}} data-ad-client="ca-pub-5185080427531248" data-ad-slot="YOUR_AD_SLOT_ID"></ins>
                            </div>
                        </aside>
                    </main>

                    {/* Footer for Legal/Trust Links */}
                    <footer className="bg-zinc-950 border-t border-zinc-900 py-8 mt-auto text-center text-zinc-500 text-sm">
                        <div className="flex flex-wrap justify-center gap-4 md:gap-6 mb-4 px-4">
                            <a href="#" className="hover:text-white transition-colors">Privacy Policy</a>
                            <a href="#" className="hover:text-white transition-colors">Terms of Service</a>
                            <a href="#" className="hover:text-white transition-colors">Cookie Policy</a>
                        </div>
                        <p>&copy; {new Date().getFullYear()} Scarcity Games. All rights reserved.</p>
                    </footer>
                </div>
            );
        }

        // ==========================================
        // 2. THE GAME ENGINE COMPONENT
        // ==========================================
        function GameEngine() {
            const [gameState, setGameState] = useState('MENU'); 
            const [endStats, setEndStats] = useState({ kills: 0, time: 0, rank: 0 });

            const inputRef = useRef({ w: false, a: false, s: false, d: false, shift: false, mouseX: 0, mouseY: 0, mouseDown: false, joyX: 0, joyY: 0, joyActive: false, mobileAttack: false, mobileDash: false });
            const wrapperRef = useRef(null);
            const canvasRef = useRef(null);
            
            // UI Refs
            const hpRef = useRef(null); const staminaRef = useRef(null); const hungerRef = useRef(null);
            const aliveRef = useRef(null); const messageRef = useRef(null); const knobRef = useRef(null); const tutorialRef = useRef(null);

            useEffect(() => {
                const handleKeyDown = (e) => { const k = e.key.toLowerCase(); if (inputRef.current[k] !== undefined) inputRef.current[k] = true; };
                const handleKeyUp = (e) => { const k = e.key.toLowerCase(); if (inputRef.current[k] !== undefined) inputRef.current[k] = false; };
                
                const handleMouseMove = (e) => { 
                    if (!wrapperRef.current) return;
                    const rect = wrapperRef.current.getBoundingClientRect();
                    inputRef.current.mouseX = e.clientX - rect.left; 
                    inputRef.current.mouseY = e.clientY - rect.top; 
                };
                
                const handleMouseDown = (e) => { 
                    if (e.button === 0 && e.target === canvasRef.current) inputRef.current.mouseDown = true; 
                };
                const handleMouseUp = (e) => { if (e.button === 0) inputRef.current.mouseDown = false; };
                
                window.addEventListener('keydown', handleKeyDown); window.addEventListener('keyup', handleKeyUp);
                window.addEventListener('mousemove', handleMouseMove, { passive: true });
                window.addEventListener('mousedown', handleMouseDown); window.addEventListener('mouseup', handleMouseUp);
                
                return () => {
                    window.removeEventListener('keydown', handleKeyDown); window.removeEventListener('keyup', handleKeyUp);
                    window.removeEventListener('mousemove', handleMouseMove);
                    window.removeEventListener('mousedown', handleMouseDown); window.removeEventListener('mouseup', handleMouseUp);
                };
            }, []);

            let joyCenter = { x: 0, y: 0 };
            const handleJoyStart = (e) => {
                const rect = e.target.getBoundingClientRect();
                joyCenter.x = rect.left + rect.width / 2; joyCenter.y = rect.top + rect.height / 2;
                inputRef.current.joyActive = true; handleJoyMove(e);
            };
            const handleJoyMove = (e) => {
                if (!inputRef.current.joyActive) return;
                const touch = e.targetTouches[0];
                let dx = touch.clientX - joyCenter.x, dy = touch.clientY - joyCenter.y;
                const dist = Math.hypot(dx, dy), maxRadius = 40;
                if (dist > maxRadius) { dx = (dx / dist) * maxRadius; dy = (dy / dist) * maxRadius; }
                if (knobRef.current) knobRef.current.style.transform = `translate(${dx}px, ${dy}px)`;
                inputRef.current.joyX = dx / maxRadius; inputRef.current.joyY = dy / maxRadius;
            };
            const handleJoyEnd = () => {
                inputRef.current.joyActive = false; inputRef.current.joyX = 0; inputRef.current.joyY = 0;
                if (knobRef.current) knobRef.current.style.transform = `translate(0px, 0px)`;
            };

            useEffect(() => {
                if (gameState !== 'PLAYING' || !canvasRef.current || !wrapperRef.current) return;
                
                const canvas = canvasRef.current;
                const wrapper = wrapperRef.current;
                const ctx = canvas.getContext('2d', { alpha: false }); 
                
                const resize = () => { 
                    canvas.width = wrapper.clientWidth; 
                    canvas.height = wrapper.clientHeight; 
                };
                window.addEventListener('resize', resize);
                resize();

                const WORLD_SIZE = 3000;
                let zoneRadius = WORLD_SIZE / 2;
                let camera = { x: 0, y: 0, shake: 0 };
                let entities = [], foods = [];
                let player = null, gameTime = 0, aliveCount = 50;

                const dist = (x1, y1, x2, y2) => Math.hypot(x2 - x1, y2 - y1);
                const PARTICLE_POOL = Array.from({ length: 400 }, () => ({ active: false, x: 0, y: 0, vx: 0, vy: 0, life: 0, maxLife: 1, color: '' }));
                
                const spawnParticle = (x, y, color, speed, life) => {
                    const p = PARTICLE_POOL.find(p => !p.active);
                    if (!p) return;
                    p.active = true; p.x = x; p.y = y; p.color = color;
                    const angle = Math.random() * Math.PI * 2;
                    p.vx = Math.cos(angle) * speed * Math.random(); 
                    p.vy = Math.sin(angle) * speed * Math.random();
                    p.life = life; p.maxLife = life;
                };

                class Food {
                    constructor(x, y) { this.x = x; this.y = y; this.active = true; this.value = 30; }
                    draw(ctx) {
                        if (!this.active) return;
                        ctx.fillStyle = '#ffaa00';
                        ctx.beginPath(); ctx.arc(this.x | 0, this.y | 0, 6, 0, Math.PI * 2); ctx.fill(); 
                    }
                }

                class Entity {
                    constructor(x, y, isPlayer) {
                        this.x = x; this.y = y; this.isPlayer = isPlayer;
                        this.radius = 16; this.color = isPlayer ? '#00ccff' : '#ff3e3e';
                        this.maxHp = isPlayer ? 150 : 100; this.hp = this.maxHp;
                        this.speed = isPlayer ? 220 : 160;
                        this.stamina = 100; this.hunger = 100;
                        this.angle = 0; this.dead = false; this.kills = 0;
                        this.dashCd = 0; this.attackCd = 0; this.hitFlash = 0;
                        this.state = 'WANDER'; this.stateTimer = 0;
                    }

                    takeDamage(amount, attacker) {
                        this.hp -= amount; this.hitFlash = 0.2;
                        for(let i=0; i<8; i++) spawnParticle(this.x, this.y, '#ff0000', 150, 0.4);
                        if (this.hp <= 0 && !this.dead) this.die(attacker);
                    }

                    die(attacker) {
                        this.dead = true; aliveCount--;
                        for(let i=0; i<25; i++) spawnParticle(this.x, this.y, this.color, 250, 0.8);
                        for(let i=0; i<3; i++) foods.push(new Food(this.x + (Math.random()*40-20), this.y + (Math.random()*40-20)));
                        
                        if (attacker && attacker.isPlayer) {
                            attacker.kills++;
                            if(messageRef.current) {
                                messageRef.current.innerText = `ELIMINATED TARGET (${aliveCount} REMAIN)`;
                                messageRef.current.style.opacity = 1;
                                setTimeout(() => { if(messageRef.current) messageRef.current.style.opacity = 0; }, 2000);
                            }
                        }

                        if (this.isPlayer || (aliveCount === 1 && player && !player.dead)) {
                            const finalRank = this.isPlayer ? aliveCount + 1 : 1;
                            const finalKills = this.isPlayer ? this.kills : player.kills;
                            setEndStats({ kills: finalKills, time: Math.floor(gameTime), rank: finalRank });
                            setGameState('GAMEOVER');
                        }
                    }

                    attack() {
                        this.attackCd = 0.4; this.stamina -= 15;
                        const swingX = this.x + Math.cos(this.angle) * 35;
                        const swingY = this.y + Math.sin(this.angle) * 35;
                        
                        spawnParticle(swingX, swingY, '#ffffff', 80, 0.15); 
                        if (this.isPlayer) camera.shake = 5;

                        entities.forEach(e => {
                            if (e === this || e.dead) return;
                            if (dist(swingX, swingY, e.x, e.y) < 50) {
                                e.x += Math.cos(this.angle) * 25; e.y += Math.sin(this.angle) * 25;
                                e.takeDamage(30, this);
                                if (this.isPlayer) camera.shake = 12;
                            }
                        });
                    }

                    update(dt) {
                        if (this.hitFlash > 0) this.hitFlash -= dt;
                        if (this.dashCd > 0) this.dashCd -= dt;
                        if (this.attackCd > 0) this.attackCd -= dt;
                        
                        this.hunger -= 0.8 * dt; 
                        if (this.hunger <= 0) { this.hunger = 0; this.takeDamage(2 * dt, null); }
                        if (this.stamina < 100) this.stamina += 15 * dt;

                        let dx = 0, dy = 0;
                        const input = inputRef.current;

                        if (this.isPlayer) {
                            if (input.w) dy -= 1; if (input.s) dy += 1;
                            if (input.a) dx -= 1; if (input.d) dx += 1;
                            
                            if (input.joyActive) {
                                dx = input.joyX; dy = input.joyY;
                                this.angle = Math.atan2(dy, dx);
                            } else {
                                const worldMouseX = input.mouseX + camera.x;
                                const worldMouseY = input.mouseY + camera.y;
                                this.angle = Math.atan2(worldMouseY - this.y, worldMouseX - this.x);
                            }

                            if ((input.shift || input.mobileDash) && this.dashCd <= 0 && this.stamina >= 30) {
                                this.dashCd = 1.0; this.stamina -= 30; dx *= 6; dy *= 6; camera.shake = 4;
                                for(let i=0; i<6; i++) spawnParticle(this.x, this.y, '#fff', 50, 0.3);
                            }
                            if ((input.mouseDown || input.mobileAttack) && this.attackCd <= 0 && this.stamina >= 15) {
                                this.attack();
                                input.mobileAttack = false; 
                            }
                        } else {
                            this.stateTimer -= dt;
                            let nearestFood = null, nearestEnemy = null;
                            let minFoodD = Infinity, minEnemyD = Infinity;

                            foods.forEach(f => {
                                if(!f.active) return;
                                const d = dist(this.x, this.y, f.x, f.y);
                                if(d < minFoodD && d < 500) { minFoodD = d; nearestFood = f; }
                            });
                            entities.forEach(e => {
                                if(e === this || e.dead) return;
                                const d = dist(this.x, this.y, e.x, e.y);
                                if(d < minEnemyD && d < 400) { minEnemyD = d; nearestEnemy = e; }
                            });

                            if (dist(0, 0, this.x, this.y) > zoneRadius * 0.9) {
                                this.state = 'SCAVENGE'; this.angle = Math.atan2(-this.y, -this.x);
                            } else if (this.hunger < 50 && nearestFood) {
                                this.state = 'WANDER'; this.angle = Math.atan2(nearestFood.y - this.y, nearestFood.x - this.x);
                            } else if (nearestEnemy) {
                                if (this.hp >= nearestEnemy.hp || this.hunger < 20) {
                                    this.state = 'CHASE'; this.angle = Math.atan2(nearestEnemy.y - this.y, nearestEnemy.x - this.x);
                                    if (minEnemyD < 45 && this.attackCd <= 0) this.attack();
                                } else {
                                    this.state = 'FLEE'; this.angle = Math.atan2(this.y - nearestEnemy.y, this.x - nearestEnemy.x);
                                }
                            } else if (this.stateTimer <= 0) {
                                this.state = 'WANDER'; this.angle = Math.random() * Math.PI * 2; this.stateTimer = 3;
                            }
                            dx = Math.cos(this.angle); dy = Math.sin(this.angle);
                        }

                        if (dx !== 0 || dy !== 0) {
                            const len = Math.hypot(dx, dy);
                            const multiplier = (len > 1) ? (1 / len) : 1; 
                            this.x += dx * multiplier * this.speed * dt;
                            this.y += dy * multiplier * this.speed * dt;
                        }

                        foods.forEach(f => {
                            if (f.active && dist(this.x, this.y, f.x, f.y) < this.radius + 10) {
                                f.active = false;
                                this.hunger = Math.min(100, this.hunger + f.value);
                                this.hp = Math.min(this.maxHp, this.hp + 15);
                                spawnParticle(this.x, this.y, '#00ff00', 60, 0.4);
                            }
                        });

                        if (dist(0, 0, this.x, this.y) > zoneRadius) this.takeDamage(15 * dt, null);
                    }

                    draw(ctx) {
                        ctx.save();
                        ctx.translate(this.x | 0, this.y | 0);
                        ctx.rotate(this.angle);
                        
                        ctx.fillStyle = this.hitFlash > 0 ? '#ffffff' : this.color;
                        ctx.beginPath(); ctx.arc(0, 0, this.radius, 0, Math.PI*2); ctx.fill();
                        
                        ctx.fillStyle = '#ffffff';
                        ctx.fillRect(this.radius - 2, -14, 12, 8);
                        ctx.fillRect(this.radius + 2, -4, 18, 8);
                        ctx.restore();

                        if (!this.isPlayer && this.hp < this.maxHp) {
                            ctx.fillStyle = '#333'; ctx.fillRect((this.x - 15) | 0, (this.y - 25) | 0, 30, 4);
                            ctx.fillStyle = '#ff0000'; ctx.fillRect((this.x - 15) | 0, (this.y - 25) | 0, 30 * (this.hp/this.maxHp), 4);
                        }
                    }
                }

                player = new Entity(0, 0, true);
                entities.push(player);
                for(let i=0; i<49; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const r = Math.random() * (zoneRadius - 200);
                    entities.push(new Entity(Math.cos(angle)*r, Math.sin(angle)*r, false));
                }
                for(let i=0; i<100; i++) foods.push(new Food((Math.random()-0.5)*WORLD_SIZE*0.8, (Math.random()-0.5)*WORLD_SIZE*0.8));

                let lastTime = performance.now();
                let animationFrameId;

                const gameLoop = (now) => {
                    const dt = Math.min((now - lastTime) / 1000, 0.05); 
                    lastTime = now;
                    gameTime += dt;

                    zoneRadius -= 0.1; 
                    if (Math.random() < 0.03) foods.push(new Food((Math.random()-0.5)*zoneRadius*2, (Math.random()-0.5)*zoneRadius*2));
                    
                    entities.forEach(e => !e.dead && e.update(dt));
                    PARTICLE_POOL.forEach(p => {
                        if (!p.active) return;
                        p.x += p.vx * dt; p.y += p.vy * dt; p.life -= dt;
                        p.vx *= 0.95; p.vy *= 0.95; 
                        if (p.life <= 0) p.active = false;
                    });

                    entities = entities.filter(e => !e.dead);
                    foods = foods.filter(f => f.active);

                    if (player && !player.dead) {
                        camera.x += (player.x - canvas.width / 2 - camera.x) * 0.15;
                        camera.y += (player.y - canvas.height / 2 - camera.y) * 0.15;
                    }
                    if (camera.shake > 0) {
                        camera.x += (Math.random() - 0.5) * camera.shake;
                        camera.y += (Math.random() - 0.5) * camera.shake;
                        camera.shake -= dt * 40;
                    }

                    // Render
                    ctx.fillStyle = '#0f0f13';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.save();
                    ctx.translate(-(camera.x | 0), -(camera.y | 0));

                    ctx.strokeStyle = '#1a1a24'; ctx.lineWidth = 2;
                    const gs = 150;
                    const sx = Math.floor(camera.x / gs) * gs;
                    const sy = Math.floor(camera.y / gs) * gs;
                    ctx.beginPath();
                    for(let x=sx; x<camera.x+canvas.width+gs; x+=gs) { ctx.moveTo(x, sy); ctx.lineTo(x, camera.y+canvas.height+gs); }
                    for(let y=sy; y<camera.y+canvas.height+gs; y+=gs) { ctx.moveTo(sx, y); ctx.lineTo(camera.x+canvas.width+gs, y); }
                    ctx.stroke();

                    ctx.beginPath(); ctx.arc(0, 0, zoneRadius, 0, Math.PI * 2);
                    ctx.strokeStyle = '#ff3e3e'; ctx.lineWidth = 4; ctx.stroke();
                    ctx.fillStyle = 'rgba(255, 0, 0, 0.1)';
                    ctx.beginPath(); ctx.arc(0, 0, WORLD_SIZE*2, 0, Math.PI*2); ctx.arc(0, 0, zoneRadius, 0, Math.PI*2, true); ctx.fill();

                    foods.forEach(f => f.draw(ctx));
                    entities.forEach(e => e.draw(ctx));
                    PARTICLE_POOL.forEach(p => {
                        if (!p.active) return;
                        ctx.globalAlpha = p.life / p.maxLife; ctx.fillStyle = p.color;
                        ctx.beginPath(); ctx.arc(p.x | 0, p.y | 0, 4, 0, Math.PI*2); ctx.fill();
                    });
                    ctx.globalAlpha = 1.0;
                    ctx.restore();

                    // Update UI HUD
                    if (player && !player.dead) {
                        if(hpRef.current) hpRef.current.style.width = `${Math.max(0, (player.hp/player.maxHp)*100)}%`;
                        if(staminaRef.current) staminaRef.current.style.width = `${Math.max(0, player.stamina)}%`;
                        if(hungerRef.current) hungerRef.current.style.width = `${Math.max(0, player.hunger)}%`;
                        if(aliveRef.current) aliveRef.current.innerText = aliveCount;
                    }

                    animationFrameId = requestAnimationFrame(gameLoop);
                };

                animationFrameId = requestAnimationFrame(gameLoop);

                return () => {
                    cancelAnimationFrame(animationFrameId);
                    window.removeEventListener('resize', resize);
                };
            }, [gameState]);

            return (
                <div id="game-wrapper" ref={wrapperRef}>
                    {gameState === 'PLAYING' && (
                        <>
                            <canvas ref={canvasRef}></canvas>

                            {/* HUD Overlay */}
                            <div className="game-ui p-3 md:p-4 flex justify-between items-start">
                                <div className="flex flex-col gap-2 w-32 md:w-48 bg-black/60 p-2 md:p-3 rounded-lg backdrop-blur-sm pointer-events-auto border border-zinc-800">
                                    <div>
                                        <div className="flex justify-between text-[10px] md:text-xs mb-1 font-bold"><span>HEALTH</span></div>
                                        <div className="h-2 md:h-3 bg-zinc-900 border border-zinc-700 rounded overflow-hidden">
                                            <div ref={hpRef} className="h-full bg-rose-500 transition-all duration-75"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <div className="flex justify-between text-[10px] md:text-xs mb-1 font-bold"><span>STAMINA</span></div>
                                        <div className="h-1.5 md:h-2 bg-zinc-900 border border-zinc-700 rounded overflow-hidden">
                                            <div ref={staminaRef} className="h-full bg-emerald-400 transition-all duration-75"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <div className="flex justify-between text-[10px] md:text-xs mb-1 font-bold"><span>HUNGER</span></div>
                                        <div className="h-1.5 md:h-2 bg-zinc-900 border border-zinc-700 rounded overflow-hidden">
                                            <div ref={hungerRef} className="h-full bg-amber-400 transition-all duration-75"></div>
                                        </div>
                                    </div>
                                </div>

                                <div className="text-right bg-black/60 p-2 md:p-3 rounded-lg backdrop-blur-sm pointer-events-auto border border-zinc-800">
                                    <div className="text-xl md:text-2xl font-black">ALIVE: <span ref={aliveRef} className="text-rose-500">50</span></div>
                                    <div className="text-[10px] md:text-xs text-zinc-400 font-bold">ZONE SHRINKING</div>
                                </div>
                            </div>

                            <div ref={messageRef} className="game-ui flex items-center justify-center text-xl md:text-3xl font-black text-white glow-text opacity-0 transition-opacity duration-300"></div>

                            {/* Mobile Controls Overlay */}
                            <div className="game-ui z-20 md:hidden">
                                <div className="absolute bottom-6 left-6 w-28 h-28 touch-btn pointer-events-auto" onTouchStart={handleJoyStart} onTouchMove={handleJoyMove} onTouchEnd={handleJoyEnd}>
                                    <div ref={knobRef} className="w-10 h-10 bg-white rounded-full shadow-[0_0_10px_rgba(255,255,255,0.5)]"></div>
                                </div>
                                <div className="absolute bottom-6 right-28 w-16 h-16 touch-btn pointer-events-auto text-[10px] tracking-widest" onTouchStart={(e) => { e.preventDefault(); inputRef.current.mobileDash = true; }} onTouchEnd={(e) => { e.preventDefault(); inputRef.current.mobileDash = false; }}>DASH</div>
                                <div className="absolute bottom-16 right-6 w-20 h-20 touch-btn pointer-events-auto text-xs tracking-widest border-rose-500 shadow-[0_0_15px_rgba(244,63,94,0.3)] bg-rose-500/10" onTouchStart={(e) => { e.preventDefault(); inputRef.current.mobileAttack = true; }} onTouchEnd={(e) => { e.preventDefault(); inputRef.current.mobileAttack = false; }}>ATTACK</div>
                            </div>
                        </>
                    )}

                    {gameState === 'MENU' && (
                        <div className="absolute inset-0 bg-zinc-950/80 backdrop-blur-sm flex flex-col items-center justify-center z-50 pointer-events-auto">
                            <h1 className="text-5xl md:text-7xl font-black text-white mb-2 tracking-widest glow-text text-center">SCARCITY</h1>
                            <p className="text-zinc-400 text-xs md:text-sm mb-8 max-w-[280px] md:max-w-sm text-center px-4 font-bold uppercase tracking-wider">The strong survive. Hunt for food. Eliminate rivals.</p>
                            <button onClick={() => setGameState('PLAYING')} className="border-2 border-white text-white px-8 py-4 text-xl font-black hover:bg-white hover:text-black transition-all duration-300 tracking-widest shadow-[0_0_15px_rgba(255,255,255,0.2)]">ENTER ARENA</button>
                        </div>
                    )}

                    {gameState === 'GAMEOVER' && (
                        <div className="absolute inset-0 bg-black/90 backdrop-blur-md flex flex-col items-center justify-center z-50 pointer-events-auto">
                            <h1 className={`text-4xl md:text-6xl font-black tracking-widest mb-6 ${endStats.rank === 1 ? 'text-emerald-500 glow-text' : 'text-rose-500 glow-text'}`}>{endStats.rank === 1 ? 'VICTORY' : 'ELIMINATED'}</h1>
                            <div className="text-base md:text-xl text-zinc-200 flex flex-col items-center gap-2 mb-8 bg-zinc-900/80 p-6 rounded-xl border border-zinc-800 font-bold w-[250px] md:w-[300px]">
                                <div className="w-full flex justify-between"><span>Rank:</span> <span className="text-white">#{endStats.rank}/50</span></div>
                                <div className="w-full flex justify-between"><span>Eliminations:</span> <span className="text-rose-400">{endStats.kills}</span></div>
                                <div className="w-full flex justify-between"><span>Survived:</span> <span className="text-emerald-400">{endStats.time}s</span></div>
                            </div>
                            <button onClick={() => setGameState('PLAYING')} className="border-2 border-rose-500 text-rose-500 px-8 py-3 text-lg hover:bg-rose-500 hover:text-white transition-all duration-300 tracking-widest uppercase font-black">PLAY AGAIN</button>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
